{% extends 'frontend/base.html' %}

{% block title %}Чат с поддержкой{% endblock %}

{% block content %}

<div id="chat-container">
        <div id="chat-messages"></div>
        <input type="text" id="chat-message-input" placeholder="Введите сообщение...">
        <button id="chat-message-submit">Отправить</button>
    </div>

    <div style="display: none;">
    Room object: {{ room }}
    Room ID: {{ room.id }}
    User ID: {{ request.user.id }}
    </div>

    <script>
        $(document).ready(function() {
    const roomId = "{{ room.id }}";  // Получаем из контекста Django
    const userId = "{{ request.user.id }}";
    
    // Проверяем наличие roomId
    if (!roomId) {
        console.error('Room ID is not defined!');
        return;
    }
    
    // Формируем URL WebSocket
    const wsUrl = 'ws://' + window.location.host + '/ws/chat/' + roomId + '/';
    console.log('Connecting to WebSocket:', wsUrl);
    
    // Подключаемся к WebSocket
    const chatSocket = new WebSocket(wsUrl);

    // Обработчик открытия соединения
    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established');
    };

    // Обработчик ошибок
    chatSocket.onerror = function(error) {
        console.error('WebSocket Error:', error);
    };

    // Обработчик закрытия соединения
    chatSocket.onclose = function(e) {
        console.log('WebSocket connection closed');
    };

    // Обработчик входящих сообщений
    chatSocket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            const message = data.message;
            const senderId = data.sender_id;
            
            const messageElement = $('<div>').addClass('message');
            if (senderId == userId) {
                messageElement.addClass('sent');
            } else {
                messageElement.addClass('received');
            }
            messageElement.text(message);
            $('#chat-messages').append(messageElement);
        } catch (error) {
            console.error('Error processing message:', error);
        }
    };

    // Отправка сообщения
    $('#chat-message-submit').click(function() {
        const messageInput = $('#chat-message-input');
        const message = messageInput.val().trim();
        
        if (message && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': message,
                'sender_id': userId
            }));
            messageInput.val('');
        }
    });

    // Отправка при нажатии Enter
    $('#chat-message-input').keyup(function(e) {
        if (e.key === 'Enter') {
            $('#chat-message-submit').click();
        }
    });
});
    </script>
{% endblock %}